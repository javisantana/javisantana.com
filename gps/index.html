<!doctype html>
<html lang=en>
  <head>
  <meta charset=utf-8>
  <title>tracker</title>
    <style>
      :root {
        --bkg-color: rgb(43, 43, 43);
        --text-color: rgba(255, 255, 255, 0.9);
      }

      html {
        font-family: Helvetica;
        background-color: var(--bkg-color);
      }
      html, body {
        height: 100%; 
        width: 100%;
        padding: 0;
        margin: 0;
      }

      .center_vertically {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        min-height: 100vh;
        flex-wrap: wrap;
      }
      #start_btn {
        padding: 5vh 14vw;
        flex: 0 0 100%;
        background: transparent;
        border: 5px solid var(--text-color);
        color: var(--text-color);
        font-weight: bold;
        letter-spacing: -0.1vh;
        font-size: 5vh;
        text-transform:uppercase;
        text-shadow: 0 0 10px #111;
      }

      #time { 
        display: none; 
        flex: 0 0 100%;
        /*flex: 99 0 99%;*/
        font-family: monospace;
        font-weight: bold;
        letter-spacing: -0.3vh;
        color: #FFF;
        text-shadow: 0 0 10px #111;
        min-width: 100vw;
      }
      #debug {
        position: fixed;
        font-family: monospace;
        font-size: 2vh;
        bottom: 1vh;
        color: #888;
        text-shadow: 0 0 10px #111;
      }
    </style>
  </head>
<body>
  <div class="center_vertically">
    <a id="start_btn">start</a>
    <div id="time">00:00.0</div>
    <div id="debug">
      <span id="pos">42.559169, -2.168215</span>
      Â·
      <span id="speed">0 kmh</span>
    </div>
  </div>
  <script src="NoSleep.min.js"></script>
  <script src="geometric.js"></script>
  <script src="flatten.js"></script>
  <script src="app.js"></script>
  <script>
      // https://stackoverflow.com/questions/59471449/how-to-prevent-screen-sleep-using-javascript
        var locations = [];
        var noSleep = new NoSleep();
        var c = 0;
        var session_id;
        var session = new Session()
        var user_id;

        var playFn = function() {
            noSleep.enable();
            document.body.removeEventListener('touchend', playFn);
            const options = {
              enableHighAccuracy: true,
              maximumAge: 30000,
              timeout: 27000
            };
            function newPos(p) {
              /*
              document.body.insertAdjacentHTML('beforeend',
                `<div>${p.timestamp},${p.coords.latitude},${p.coords.latitude}, ${p.coords.altitude},${p.coords.speed}</div>`
              )
              */
              if(p.coords.speed !== undefined)
                document.getElementById('speed').innerHTML = `${(3.6 * p.coords.speed).toFixed(0)} kmh`
              if(p.coords !== undefined)
                document.getElementById('pos').innerHTML = `${p.coords.longitude},${p.coords.latitude}`

              locations.push([p.timestamp, p.coords.longitude, p.coords.latitude, p.coords.altitude, p.coords.speed ])
              var utc = new Date().toJSON().slice(0,10).replace(/-/g,'/');
              if (c % 10 == 0)
                localStorage.setItem(utc, JSON.stringify(locations));
              ++c;
              
              sendEvent({ts:p.timestamp,lat: p.coords.latitude, lon:p.coords.longitude, alt: p.coords.altitude, speed: p.coords.speed, session:session_id, uid: user_id})
              session.newPos(p.coords.timestamp, [
                p.coords.longitude,
                p.coords.latitude
              ], p.coords.speed)

            }
            const watchID = navigator.geolocation.watchPosition(newPos, (e) => console.log(e), options);
            navigator.geolocation.getCurrentPosition(newPos, (e) => console.log(e), options);

            // hide start button and show stuff
            document.getElementById('start_btn').style.display = 'none';
            document.getElementById('time').style.display = 'block';
            fitText(document.getElementById('time'));
          
      }
      document.body.addEventListener('touchend', playFn);
      document.body.addEventListener('click', playFn);

      [session_id, user_id] = flatout_init();

  </script>
</body>
</html>

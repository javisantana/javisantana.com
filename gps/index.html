<!doctype html>
<html lang=en>
  <head>
  <meta charset=utf-8>
  <title>tracker</title>
    <style>
      html {
        font-family: Helvetica;
        padding: 20px;
      }
      .button {
        padding: 20px 30px;
        background: #333;
        color: white;
        font-weight: bold;
        font-size: 1.5em;
        text-transform:uppercase;
      }
      #speed {
        font-size: 10em;
      }
    </style>
  </head>
<body>
  <a id="start_btn" class="button">start</a>
  <div id="speed">0</div>
  <script src="NoSleep.min.js"></script>
  <script>
      // https://stackoverflow.com/questions/59471449/how-to-prevent-screen-sleep-using-javascript
        var locations = [];
        var noSleep = new NoSleep();
        var c = 0;
        var session;
        var playFn = function() {
            noSleep.enable();
            document.body.removeEventListener('touchend', playFn);
            const options = {
              enableHighAccuracy: true,
              maximumAge: 30000,
              timeout: 27000
            };
            function printPos(p) {
              console.log(p);
              document.body.insertAdjacentHTML('beforeend',
                `<div>${p.timestamp},${p.coords.latitude},${p.coords.latitude}, ${p.coords.altitude},${p.coords.speed}</div>`
              )
              if(p.coords.speed)
               document.getElementById('speed').innerHTML = (3.6 * p.coords.speed).toFixed(2)

              locations.push([p.timestamp,p.coords.latitude,p.coords.latitude, p.coords.altitude, p.coords.speed])
              var utc = new Date().toJSON().slice(0,10).replace(/-/g,'/');
              if (c % 10 == 0)
                localStorage.setItem(utc, JSON.stringify(locations));
              ++c;
              
              sendEvent({ts:p.timestamp,lat: p.coords.latitude, lon:p.coords.longitude, alt: p.coords.altitude, speed: p.coords.speed, session:session})

            }
            const watchID = navigator.geolocation.watchPosition(printPos, (e) => console.log(e), options);
            //setInterval(() => { }, 1000)
            navigator.geolocation.getCurrentPosition(printPos, (e) => console.log(e), options);
            document.getElementById('start_btn').style.display = 'none';
          
      }
      document.body.addEventListener('touchend', playFn);
      document.body.addEventListener('click', playFn);

function uuidv4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}
      session = uuidv4()
      async function sendEvent(event){
          const date = new Date();
          event = {
              'timestamp': date.toISOString(),
              ...event
          }
          const headers = {
              'Authorization': `Bearer p.eyJ1IjogImM4YWY4Zjg2LWQzY2EtNGRhNy1iMWVhLWUyNmMxN2ViNGI0OSIsICJpZCI6ICJlZTM1MjMwZi0xYmZlLTQ4N2MtOTRjNC1jYjA1NjExM2Y3NDYifQ.GBO3WIIltxMDskzBA6HUaBoR17vm4kQVglgfB8Ew8lk`,
          }
          const rawResponse = await fetch('https://api.tinybird.co/v0/events?name=gps_tracker', {
              method: 'POST',
              body: JSON.stringify(event),
              headers: headers,
          });
          const content = await rawResponse.json();
          console.log(content)
      }
      
  </script>
</body>
</html>
